# 第09节：cookie与session

### 一、概述

对于一个网站，如何保持用户的登录状态，以及再次登录被网站识别出来，这就需要cookie（写在客户端）和session（记录在服务器）

简单理解：cookie就是我去一个理发店理发，老板给我办个了会员卡（服务器设置cookie），下次我再去理发带上卡（下一次的请求会带上这个cookie）卡老板就知道是我。而session就是张加密的卡，更加安全。

### 二、cookie

网站服务器程序可以在浏览器中写入cookie（通过response请求写入），然后浏览器再次访问这个网站时，就会带着这个cookie（通过request请求）

需要set方法设置cookie的键值对，通过get方法获取cookie的键值对

```js
// 设置cookie
router.get("/", async ctx => {
    // cookie是以明值对的方式记录在客户端（浏览器）
    ctx.cookies.set("user","admin")//即第一个set的第一个参数为属性，第二个参数为属性值，第三个参数为一个对象表示对这个cookie的进一步设置，比如过期时间maxAge
    ctx.body = "cookie"
})
// 获取cookie，并且记录网页访问次数
router.get("/test", async ctx => {
    // let user = ctx.cookies.get("user");
    // ctx.body = user
    let count = ctx.cookies.get("count");//获取cookie的属性为count的属性值
    if(count>0){ //判断有无cookie
        ++count;
        ctx.cookies.set("count",count,{
            maxAge:2000 //设置cookie过期时间为2秒
        });
    }else{
        count = 1;
        ctx.cookies.set("count",1);
    }
    ctx.body = count
})

```

### 三、session

利用cookie在客户端存储数据是完全透明的，如果存储一些用户信息，会导致很严重的安全问题，所以为了记住用户的登录状态，需要使用cookie与session结合的方式。

使用session需要安装依赖`cnpm install --save koa-session`

session设置和获取属性

```js
ctx.session.count = 0;//设置count属性并赋值0
let count = ctx.session.count //获取count属性的属性值
```

#### 通过session来记录网页访问次数

```js
const session = require("koa-session");//引入依赖

//加密的密钥，服务器通过加密的cookie获取session
app.keys = ["1234"];
app.use(session({
    maxAge:2000, //设置session生效的时间
},app)) // 引入依赖的操作，两个参数，第一个是设置session的一些属性，第二参数就是app

router.get("/session", async ctx => {
    if(ctx.session.count>0){
        ++ctx.session.count;
    }else{
        ctx.session.count = 1;
    }
    ctx.body = ctx.session.count
})
```

### 四、登录验证

见代码cookie_session的代码login.js是后台代码