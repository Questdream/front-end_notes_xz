# 第02节：ajax入门

### 一、概述

之前的内容，向服务器发送请求后，在浏览器中响应的页面是整页刷新。

在某些项目中，我们只希望获取页面的局部数据，而不必整页刷新，这个时候就需要ajax。

全称是Asynchronous JavaScript and XML(异步的JavaScript和XML)

这个概念出来较早，那时候前端和后台数据交互主要以XML格式为主，但目前主流数据格式还是json(JavaScript对象表示法)如下：

```js
// 早期的XML格式
<fruit>
    <name>apple</name>
	<weight>0.5kg</weight>
	<color>red</color>
</fruit>

//如今的json格式
{
    "fruit":{
        "name":"apple",
        "weight":"0.5kg",
        "color":"red"
    }
}
```

以后使用ajax传递数据都是使用json格式 ，ajax的优缺点：

* 优点：按需获取数据，提升系统性能
* 缺点：异步获取数据，不利于搜索引擎优化

### 二、ajax原理

回忆一下之前如何向服务器发送请求：

* 在浏览器中直接输入网址
* a标签实现的页面跳转
* 表单提交按钮
* postman模拟http请求

ajax的原理是通过XMLhttpRequest对象向服务器发送请求。

```js
//后台程序
router.get("/", async ctx => {
    await ctx.render("index")
})
router.get("/data", async ctx => {
    ctx.body = "hello world"
})

//前端程序
var xhr = new XMLHttpRequest();//创建XHR对象
xhr.open("get","/data");//规定请求类型和路径
xhr.send();//发送请求
xhr.onreadystatechange = function(){//监听readyState事件
    //0:请求未初始化
    //1:服务器连接建立
    //2:请求已接收
    //3:请求处理中
    //4:请求已完成，切响应已就绪
    if(xhr.readyState === 4 && xhr.status ===200){
        alert(xhr.responseText)
    }
    
}
```

其实上面代码在实际开发项目中并不用，因为会引入第三方ajax库来处理异步请求。

### 三、封装一个ajax方法

#### 回调函数处理异步封装

```js
//因为ajax是异步操作，因此封装ajax不能用return获取返回值，这里通过回调函数封装ajax方法。
function myAjax(method,url,next){
    let xhr = new XHLHttpRequest();
    xhr.open(method,url);
    xhr.send();
    xhr.onredystatechange = function(){
        if(xhr.readyState === 4 && xhr.status ===200){
            next(xhr.responseText);
        }
    }
}

document.querySelector("button").onclick = function(){
    myAjax("get","/data", (data) => {
        alert(data);
    })
}
```

#### 通过promise来封装ajax

过多使用回调函数会使得程序变得很难维护

```js
function myAjax(method,url){
    return new Promise(function(resolve,reject){
        let xhr = new XMLHttpRequest();
        xhr.open(method,url);
        xhr.send();//可以向后台传输数据
        xhr.onreadystatechange = function(){
            if(xhr.readyState === 4 && xhr.stauts ===200){
                resolve(xhr.respnseText);
            }
        }
        reject("获取数据失败")
    })
}

document.querySelector("button").onclick = async function(){
    myAjax("get","/data").then(function(data){
        alert(data);
    })
}
```

使用async函数才是处理异步问题的终极解决方案，以后会尽量使用async函数来处理异步。



