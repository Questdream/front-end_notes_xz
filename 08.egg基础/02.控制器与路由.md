# 第02节： 控制器与路由

### 一、概述

**MVC概述:** 

是模型（model）--视图（view）--控制器（controller）的缩写

是一种软件设计规范，主要作用就是逻辑拆分：

1. 视图为用户展示数据
2. 控制器用来处理用户输入
3. 模型用于处理数据

**控制器概述：**

负责解析用户的输入，处理后返回相应的结果。

1. 直接响应数据或者渲染模板。
2. 接受用户的输入。
3. 与路由建立对应关系

`this.ctx`可以获取到当前请求的上下文对象，通过此对象可以便捷获取到请求与响应的属性与方法。

路由：主要用来描述请求URL和具体承担执行动作的Controller的对应关系。

### 二、定义控制器与联系路由

配置app/controller目录下一个fruits.js文件，此文件就是一个控制器

```js
const Controller = require("egg").Controller;
class FruitsController extends Controller {
    async index(){
        this.ctx.body = "我是一个水果列表页面"
    }
}
module.exports = FruitsController;
```

配置app/router.js里面定义URL路由规则来联系到这个控制器：

```js
'use strict';
module.exports = app => {
    const {router, controller} = app;
    router.get("/", controller.home.index);
    router.get("/fruits", controller.fruits.index);
}
```

### 三、通过路由传递参数

**get请求的参数获取**

路由设置：

```js
module.exports = app => {
  const { router, controller } = app;
  router.get('/', controller.home.index);
  router.get('/fruits', controller.fruits.index);
  router.get('/fruits/:id', controller.fruits.getId);
};
```

1. 获取query参数

   ```js
    async index(){
           let query = this.ctx.request.query;// query为获取到get请求的url中？后面的参数，形如?in=100,就可以获得{in:"100"},就有且只有一个键值对
           console.log(query);
           this.ctx.body = `传递的index值为${query.index}` //ctx表示上下文对象，body表示响应内容
       }
   ```

2. 获取params参数

   ```js
    async getId(){
           let id = this.ctx.params.id;//也是get请求，先在路由里面写好/:id，即表示绑定了id属性在params中，在url中输入/123,就可以获取到这个123，表示id=123
           this.ctx.body = `传递的id是${id}`
       }
   ```

**post请求获取参数**

`this.ctx.request.body` 即可以获取到post请求提交的数据

在controller中可以处理表单提交的数据。然后首先需要如下设置：

CSRF指跨站请求伪造， Egg中对post请求做了一些安全验证，可以在config.default.js文件中，通过下面的设置验证。即可以提交表单

```js
config.security = {
    csrf:{
        enable:false,
    }
}
```

### 四、restful风格的URL定义

restful风格的url可以简化路由文件，其实就是吧路径和控制器方法对应起来

```js
router.resources("fruits","/fruits",controller.fruits);//一个方法同时定义增删改查。第一个参数为routerName，第二参数为path，第三个就是控制器
```

| Path             | Method | Controller.action                      |
| ---------------- | ------ | -------------------------------------- |
| /fruits          | get    | app.controllers.fruits.index           |
| /fruits/new      | get    | app.controllers.fruits.new //必须是new |
| /fruits/:id      | get    | app.controllers.fruits.show            |
| /fruits/:id/edit | get    | app.controllers.fruits.edit            |
| /fruits          | post   | app.controllers.fruits.create          |
| /fruits/:id      | put    | app.controllers.fruits.update          |
| /fruits/:id      | delete | app.controllers.fruits.destroy         |

注意这几个方法名时定死了，不能改变，路径与方法一一对应

post表单提交后，如果直接点刷新就是重新提交表单的post请求了，在搜索栏回车就是get请求