# 第03节：插件

egg通过插件实现功能扩展

* egg-view-nunjucks:nunjucks模板插件
* egg-cors:跨域请求配置插件

### 一、egg-view-nunjucks

使用模板引擎

1. `cnpm i -S egg-view-nunjucks`

2. 在plugin.js文件中引入插件，在config.default.js中配置插件

   模板配置：

   ```js
   //plugin.js
   nunjucks:{
       enable:true,
       package:'egg-view-nunjucks',
   }
       
   //config.default.js
   config.view = {
       defaultViewEngine:'nunjucks'
   }
   ```

   

3. 在view目录中创建模板文件，并在控制器中使用render方法渲染模板。

```js
//首先在view目录中新建一个模板HTML文件，/view/index.html
<body>
    <h1>水果列表</h1>
    <ul>
        {% for item in fruits %}
            <li>{{item}}</li>
        {% endfor %}
    </ul>
</body>
//然后在控制器home.js中渲染index.html， /app/controller/home.js
class HomeController extends Controller {
  async index() {
    const { ctx } = this;
    // ctx.body = 'hi, egg';
    await ctx.render("index",{fruits:["香蕉","苹果","鸭梨"]})
  }
}   
```

### 二、egg-cors

1. 首先安装，`cnpm i -S egg-cors`

2. 在plugin.js文件中引入插件

   ```js
   cors:{
       enable:true,
       package:'egg-cors'
   }
   ```

3. 在config.default.js文件中配置egg-cors插件

   ```js
   config.cors = {
       origin:"*",
       allowMethods:'GET,HEAD,PUT,POST,DELETE,PATCH'
   }
   ```

### 三、定义restful接口，实现数据交互

```js
// 前端代码
<template>
  <div>
    <form @submit.prevent="postData">
      <input type="text" v-model="fruit">
      <button>添加</button>
    </form>
    <ul>
      <li v-for="(item,index) of fruitList" :key="index">
        {{item}}
        <button @click="del(index)">删除</button>
      </li>
    </ul>
  </div>
</template>

<script>
import axios from "axios"
export default {
  data(){
    return {
      fruitList:[],
      fruit:""
    }
  },
  created(){
    this.getData();
  },
  methods:{
    getData(){
      axios.get("http://127.0.0.1:7001/fruits").then((res) => {
      this.fruitList = res.data 
      })
    },
    postData(){
      axios.post("http://127.0.0.1:7001/fruits",{fruit:this.fruit})
      .then(() => {
        this.getData();
      })
    },
    del(index){
      axios.delete(`http://127.0.0.1:7001/fruits/${index}`)
      .then(() => {
        this.getData();
      })
    }
  }
}
</script>

// 后台代码
// router.js
'use strict';

/**
 * @param {Egg.Application} app - egg application
 */
module.exports = app => {
  const { router, controller } = app;
  router.get('/', controller.home.index);
  router.get("/data",controller.home.getData);
  router.resources("fruits","/fruits", controller.fruits)
};
// 控制器fruits.js
'use strict';

const Controller = require('egg').Controller;
let fruitList = ["香蕉","苹果","鸭梨"]
class FruitsController extends Controller {
    // fruits get请求
    async index() {
        this.ctx.body = fruitList;
  }

  // post 请求
  async create(){
      const fruit = this.ctx.request.body.fruit;
      fruitList.push(fruit);
      this.ctx.body = "添加成功"
  }

  // /fruits/:id delete请求
  async destroy(){
      let id = this.ctx.params.id;
      fruitList.splice(id,1);
      this.ctx.body = "删除成功"
  }
 
}

module.exports = FruitsController;
```

### 四、安全设置

在config.defalut.js中设置下面代码，允许post请求

```js
config.security = {
    csrf: {
        enable:false,
    }
}
```



