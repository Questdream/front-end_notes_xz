# 第04节：保持用户登录状态

## 知识点回顾

### http协议

1. 请求，响应；

   请求：get ,post ,delete, put

   响应：

   ​	状态：200,404,500

   ​	数据：json格式(JavaScript对象表示法)

   ```js
   {
       "name":"小明"，
       "age":2
   }
   ["香蕉","苹果"]
   ```

2. http协议是一个无状态的协议；

   访问一个电商网站：登录和购物车，是一个用户请求

   **服务器如何识别用户：**
   
   1. 使用cookie与session识别用户。
   2. 使用JWT（Json Web Token)识别用户。
   
   

### 一、JWT概述

* json: javascript对象表示法，用js的对象来表示数据格式，比如[{name:""},{name:""}]
* token:加密字符串(标识)，客户端带着token向服务器发送请求，已证明自己的身份

#### 安装和配置egg-jwt插件（生成token）

**安装：**`npm insall --save egg-jwt`

**配置：**

在confg/plugin.js中配置：

```js
jwt:{
    enble:true,
    package:"egg-jwt"
}
```

在config.default.js文件，设置secret，注意secret不能泄露。

```js
config.jwt = {secret:"xxxxx"}
```

### 二、生成token

实现简单的token加密，使用`this.app.jwt.sign`方法可以对上方的username实现加密，

```js
async index(){
    let username = {
        name:"xiaoming"
    }
    // egg-jwt生成token
    let token = this.app.jwt.sign(user,this.app.config.jwt.secret);
    this.ctx.body = token;
}
```

通过已经封装好的egg-jwt加密算法，只要调用这个方法就可以实现token的加密功能。

### 三、验证流程

验证流程如下：

1. 根据用户信息，生成token，并相应给客户端
2. 客户端存储在localstorage中
3. 每次请求数据，请求头携带token
4. 服务器接收请求时验证请求头的token，验证成功则响应数据

### 四、解析token

简单的用户登录验证，可以检测token获取校验是否成功，使用try语句就可以模拟假token验证，如果verify后不用我们手动生成的token去换成随机的字符串会报异常。

所以我们使用try...catch语句，如果token验证成功则执行try语句，如果token验证失败则会执行catch语句。

```js
// 用户登录（加密）
let token = this.app.jwt.sign(user,this.app.config.jwt.secret);

// 解析token
try{
    let decode = this.app.jwt.verify(token,this.app.config.jwt.secret)
    this.ctx.body = decode;
}catch(e){
    this.ctx.body  = "token未能通过验证"
}
```

