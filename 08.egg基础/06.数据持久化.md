# 第06节：数据持久化

### 一、概述

数据持久化

1. 应用程序的数据通常存储在数据库中
2. 我们使用MySQL数据库实现数据的持久化
3. 为了更为方便的操作mysql，我们使用sequelize（ORM框架）管理数据层的代码。

### 二、ORM(对象关系映射)

对象关系映射（object relational mapping，简称ORM)

1. 将数据从对象形式转换为表格的形式。
2. sequelize是一个基于node的ORM框架
3. 通过egg-sequelize,可以直接使用sequelize提供的方法操作数据库，而不需要动手写SQL语句

### 三、安装sequelize

在egg项目中安装和使用sequelize：

1. 下载egg-sequelize:`npm install --save egg-sequelize mysql2`

2. 在plugin.js文件中引入插件

   ```js
   module.exports = {
       sequelize: {
           enable:true,
           package:'egg-sequelize'
       }
   }
   ```

3. 在config.default.js文件中配置数据库连接

   ```js
   config.sequelize = {
       dialect:"mysql",
       database:lxx,
       host:'localhost',
       port:3306,
       username:"root",
       password:"123456"
   }
   ```

   

4. 在app/model文件中创建数据模型

5. 添加app.js文件，初始化数据库

### 四、数据类型对应

MySQL数据类型与sequelize数据类型对应如下：

1. STRING  => varchar(255)
2. INTEGRE => int
3. DOUBLE => double
4. DATE => datetime
5. TEXT => text

### 五、定义表在model中

在app/model目录中创建clazz.js文件，对应数据库汇总的clazz表

```js
module.exports = app => {
    const {STRING} = app.Sequelize;
    // 默认情况下，sequelize将自动把所有传递的模型名称（define的第一个参数）转换为复数形式
    const Clazz = app.model.define('clazz', {
        name:STRING,
    })
    return Clazz;
}
```

在主目录下创建app.js来启动项目时自动创建模型里面的所有表

```js
module.exports = app => {
    app.beforeStart(async function(){
        // sync方法会根据模型去创建表
        await app.model.sync({});
    })
}
```

### 六、数据操作

在controller中实现数据的增删改查

注：在真实项目中，controller和操作数据的逻辑要分离，以便于项目的扩展与维护。

```js
this.app.model.Clazz.findAll();// 查询数据
this.app.model.Clazz.findAll({where:{id:1}}); //通过where设置查询条件
this.app.model.Clazz.create({name:"xx"}); // 添加数据
this.app.model.CLazz.update({name:"xx",{where:{id:1}}}); // 通过条件修改数据
this.app.model.Clazz.destroy({where:{id:1}}); // 通过条件删除数据
```

### 七、添加外键

在student通过associate属性指定外键

1. 创建一个名为clazz的班级表，包含id和name两个字段
2. 学生的模型中添加如下代码，新增外键

```js
Student.associate = function(){// 所属哪个班级，指向班级主键
    app.model.Student.belongsTo(app.model.Clazz,{
        foreignKey:"clazz_id",
        as:"clazz"
    })
}
```

