# 第08节：从零开发到部署一个完整的项目

### 一、开发与部署流程如下：

案例hello world

1. 创建数据库

   ```js
   // 进入数据库
   mysql -u root -p
   // 输入密码进入
   //创建数据库
   create database hello;
   ```

2. 创建egg项目和vue项目

   ```js
   // 创建egg项目和启动
   cnpm init egg --type=simple
   cd init
   cnpm install
   npm run dev
   
   // 创建vue项目和启动
   vue create hello
   // 选手动安装，空格勾选Router，然后一直回车
   cd hello
   npm run serve
   ```

3. 安装必要的第三方依赖：后台有egg-sequelize，mysql2, egg-cors，egg-jwt；前端有：axios

   ```js
   cnpm install --save egg-sequelize egg-cors egg-jwt mysql2 //在egg项目下
   cnpm install --save axios //在vue项下
   ```

4. 引入插件和配置插件

   ```js
   // 在plugin.js中配置
   sequelize: {
       enable: true,
       package:"egg-sequelize"
     },
     cors: {
       enable: true,
       package: "egg-cors"
     },
     jwt:{
       enable:true,
       package:"egg-jwt"
     }
   // 在config.default.js中
   config.sequelize = {
       dialect: "mysql",
       database: "helloworld",
       host: "localhost",
       port: 3306,
       username: "root",
       password: "liuxuxing00",
       timezone: "+08:00"
     }
   
     config.jwt = {
       secret: "123456"
     }
   
     config.cors = {
       origin: "*", //允许所有跨域访问，注释掉则允许上面白名单访问
       credentials: true, // 允许跨域请求携带cookie
       allowMthods: "GET,HEAD,PUT,POST,DELETE,PATCH"
     }
   
     config.security = {
       csrf: {
         enable: false,
       }
     }
   ```

5. 编写数据模型

6. 数据库初始化(表)

7. 编写controller和service，响应数据

8. 前端请求数据，并展示数据

### 二、一些问题

问题1：那么多请求，是不是都要写完整的url

​	方法一：可以通过两个文件来部署开发环境和生产环境来设置变量。在主目录下生产两个文件即`.env.production和.env.developmet`两个文件来同定义一个变量，比如`VUE_APP_BASE_API = "http://127.0.0.1:7001"`

​	方法二：通过封装axios请求，首先创建utils文件夹，创建request.js文件来设置baseurl，使得每次请求时携带相应的链接地址：

```js
//../utils/request.js
import axios from "axios";

const request = axios.create({
    baseURL:process.env.VUE_APP_BASE_API
})

export default request;
// 引入
import request from "../utils/request"
export default {
  data(){
    return {
      username:""
    }
  },
  methods:{
    login(){
      // axios.post(`${process.env.VUE_APP_BASE_API}/login`,{username:this.username})
      request.post(`/login`,{username:this.username})
      .then((res) => {
        if(res.data.code === 20000){
          localStorage.setItem("token", res.data.token);
          this.$router.push("/")
        }
      })
    }
  }
}
```



问题2：那么多请求，是不是要一个个加token

​	可以在上述的封装函数中添加拦截器，使得每次请求都加上token字段，而不需在每次都添加

```js
//../utils/request.js
import axios from "axios";

const request = axios.create({
    baseURL:process.env.VUE_APP_BASE_API
})

// 拦截器
request.interceptors.request.use((req) => {
    let token = localStorage.getItem("token");
    if(token){
        req.headers.token = token;
    }
    return req
})

export default request;
```

问题3：为什么每次获取请求，都要在res后面加一个data

问题4：为什么将dist中的文件放到app/public目录下，无法看到前端页面

前端部署

1. `npm run build`:打包vue项目

2. 将打包后的vue项目放到egg的静态文件目录中（默认为app/public）

3. 配置egg的静态文件访问路径（默认http://127.0.0.1:7001/public/index)

   ```js
   config.static = {
       prefix:"/", //访问路径
       dir: path.join(appInfo.baseDir,"app/public"), // 设置静态文件目录
   }
   ```

   

问题5：正式发布项目如何启动和关闭服务器

在开发过程中需要一些错误提示，因此使用`npm run dev`来启动服务器

正式部署时使用`npm start`和`npm stop`关闭服务器

未解决问题：最后start和stop都出现问题，

start出现问题通过加入--ignore-stderr貌似解决，可以开启服务器了，但是发生stop也出现错误，导致不能关闭服务器，在网上找了一些办法都无法解决(搞了一上午加晚上实在不想搞了)，未果，心想npm run dev没问题，在部署时才出现问题，就不想管了，等到时候真的部署时再来看，说不定是版本等什么问题，就自然修复后可以解决，哎~

```
"scripts": {
    "start": "egg-scripts start --daemon --title=egg-server-hello --ignore-stderr",
    "stop": "egg-scripts stop --title=egg-server-hello",
```

